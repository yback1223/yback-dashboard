# ------------------------------------------------
# 1ë‹¨ê³„: Flutter ë¹Œë“œ (Build Stage)
# ------------------------------------------------
FROM ghcr.io/cirruslabs/flutter:stable AS build

WORKDIR /app
COPY . .

RUN flutter pub get
RUN flutter build web --release

# ğŸ‘‡ [ì¶”ê°€] ìºì‹œ ë²„ìŠ¤íŒ… ìë™í™” (sed ëª…ë ¹ì–´ë¡œ íŒŒì¼ ë‚´ìš© ì¹˜í™˜)
# 1. index.html ì•ˆì˜ flutter.js ë’¤ì— ?v=íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
RUN sed -i "s/flutter.js/flutter.js?v=$(date +%s)/g" build/web/index.html

# 2. flutter.js ì•ˆì˜ main.dart.js ë’¤ì— ?v=íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
RUN sed -i "s/main.dart.js/main.dart.js?v=$(date +%s)/g" build/web/flutter.js

# ------------------------------------------------
# 2ë‹¨ê³„: Nginx ë°°í¬
# ------------------------------------------------
FROM nginx:alpine
COPY --from=build /app/build/web /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]